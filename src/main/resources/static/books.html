<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ctrl+Book — your shortcut to reviews</title>
    <link rel="stylesheet" href="/css/style.css" />
    <style>
      .wrap { max-width: 1100px; margin: 40px auto; padding: 0 16px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
      .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
      .title { font-size: 18px; font-weight: 600; color: #0b0217; margin-bottom: 8px; }
      .muted { color: #555; font-size: 13px; }
      .stars { color: #f5b301; margin-left: 6px; }
      .review { background: #f7f7f9; padding: 10px; border-radius: 8px; margin-top: 10px; min-height: 48px; }
      .chip { display:inline-block;background:#eee;border-radius:999px;padding:4px 10px;margin-right:6px;font-size:12px;color:#333; }
      header { display:flex; justify-content: space-between; align-items:center; margin: 20px 0; }
      a.btn { text-decoration:none; background:#7d2ae8; color:#fff; padding:8px 12px; border-radius:8px; }
             .btn-secondary { background:#0b0217; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-block; margin-top:10px; }
       
       /* Genre Filter */
       .genre-filter { display: flex; align-items: center; gap: 10px; }
       .genre-filter label { color: #0b0217; font-weight: 500; }
       .genre-filter select { padding: 6px 12px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
       
       /* Genre Tag */
       .genre-tag { 
         display: inline-block; 
         background: #7d2ae8; 
         color: #fff; 
         padding: 4px 8px; 
         border-radius: 12px; 
         font-size: 11px; 
         font-weight: 500; 
         margin: 8px 0; 
         text-transform: uppercase; 
         letter-spacing: 0.5px;
       }
      /* Modal */
      .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index: 1000; }
      .modal { background:#fff; width: 95%; max-width: 520px; border-radius: 12px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
      .modal header { margin: 0 0 12px 0; }
      .modal .field { margin: 10px 0; }
      .modal label { display:block; margin-bottom:6px; color:#0b0217; }
      .modal input[type="text"], .modal textarea { width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:8px; }
      .modal textarea { min-height: 90px; resize: vertical; }
      .rating { display:flex; gap:6px; font-size:22px; cursor:pointer; color:#ccc; }
      .rating .star.selected, .rating .star.hover { color:#f5b301; }
      .modal footer { display:flex; gap:10px; justify-content:flex-end; margin-top: 14px; }
      .modal .btn-primary { background:#7d2ae8; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
      .modal .btn-outline { background:#fff; color:#0b0217; border:1px solid #ccc; padding:8px 12px; border-radius:8px; cursor:pointer; }
      
    </style>
  </head>
  <body style="background:#f5f7fb;">
    <div class="wrap">
      <header>
        <h2>Ctrl+Book — your shortcut to reviews</h2>
        <div class="genre-filter">
          <label for="genreSelect">Filter by Genre:</label>
          <select id="genreSelect">
            <option value="">All Books</option>
            <option value="Fantasy">Fantasy</option>
            <option value="Science Fiction">Science Fiction</option>
            <option value="Romance">Romance</option>
            <option value="Thriller">Thriller</option>
            <option value="Contemporary">Contemporary</option>
            <option value="Historical Fiction">Historical Fiction</option>
            <option value="Dystopian">Dystopian</option>
            <option value="Classic">Classic</option>
            <option value="Young Adult">Young Adult</option>
            <option value="Horror">Horror</option>
            <option value="Adventure">Adventure</option>
            <option value="Philosophical">Philosophical</option>
            <option value="Magical Realism">Magical Realism</option>
            <option value="Cyberpunk">Cyberpunk</option>
            <option value="Post-Apocalyptic">Post-Apocalyptic</option>
            <option value="Allegory">Allegory</option>
            <option value="Coming-of-Age">Coming-of-Age</option>
            <option value="Fantasy Romance">Fantasy Romance</option>
          </select>
        </div>
        <a class="btn" href="/index.html">Logout</a>
      </header>

      <div id="books" class="grid"></div>
    </div>
    <!-- Book Details Modal -->
    <div id="detailsBackdrop" class="modal-backdrop">
      <div class="modal">
        <header>
          <h3 id="detailsTitle">Book details</h3>
        </header>
        <div class="field"><div id="detailsMeta" class="muted"></div></div>
        <div class="field">
          <label>Reviews</label>
          <div id="detailsReviews"></div>
        </div>
        <footer>
          <button id="closeDetailsBtn" class="btn-outline" type="button">Close</button>
          <button id="openReviewFromDetails" class="btn-primary" type="button">Leave a review</button>
        </footer>
      </div>
    </div>
    <!-- Review Modal -->
    <div id="reviewBackdrop" class="modal-backdrop">
      <div class="modal review-form">
        <header>
          <h3>Add your review</h3>
        </header>
        <div class="field">
          <label>Book</label>
          <div id="reviewBookName" class="muted"></div>
        </div>
        <div class="field">
          <label for="reviewUsername">Your Name</label>
          <input type="text" id="reviewUsername" placeholder="Enter your name" required />
        </div>
        <div class="field">
          <label for="reviewText">Your review</label>
          <textarea id="reviewText" placeholder="Share your thoughts..."></textarea>
        </div>
        <div class="field">
          <label>Your rating</label>
          <div id="reviewStars" class="rating" role="radiogroup" aria-label="Star rating">
            <span class="star" data-value="1">★</span>
            <span class="star" data-value="2">★</span>
            <span class="star" data-value="3">★</span>
            <span class="star" data-value="4">★</span>
            <span class="star" data-value="5">★</span>
          </div>
        </div>
        <footer>
          <button id="cancelReviewBtn" class="btn-outline" type="button">Cancel</button>
          <button id="submitReviewBtn" class="btn-primary" type="button">Submit review</button>
        </footer>
      </div>
    </div>
    <script>
      function starsFromRating(r){
        const rating = Math.max(0, Math.min(5, Math.round((r || 0) * 2) / 2));
        const full = Math.floor(rating);
        const half = rating - full >= 0.5 ? 1 : 0;
        const empty = 5 - full - half;
        return '★'.repeat(full) + (half ? '☆' : '') + '✩'.repeat(empty);
      }

      // Books will be fetched from MongoDB via backend API

      function renderBooks(container, items){
        container.innerHTML = '';
        items.forEach(b => {
          const card = document.createElement('div');
          card.className = 'card';
                     card.innerHTML = `
             <div class="title">${b.name || 'Untitled'}</div>
             <div class="muted">by ${b.authore || 'Unknown'}</div>
             
             <a href="#" class="btn-secondary btn-details" data-book="${b.name || ''}">View details</a>
             <a href="#" class="btn-secondary btn-review" data-book="${b.name || ''}" style="margin-left:8px">Leave a review</a>
           `;
          container.appendChild(card);
        });
      }

      async function load(){
        const container = document.getElementById('books');
        container.innerHTML = 'Loading...';
        try {
          const res = await fetch('/books/getAllBooks');
          if (res.ok) {
            const list = await res.json();
            if (Array.isArray(list) && list.length > 0){
              renderBooks(container, list);
            } else {
              container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">No books found in database</div>';
            }
          } else {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Failed to load books from server</div>';
          }
        } catch (e) {
          console.error('Error loading books:', e);
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Error connecting to server</div>';
        }
      }
      
      // Review Modal logic
      const backdrop = document.getElementById('reviewBackdrop');
      const bookNameEl = document.getElementById('reviewBookName');
      const reviewTextEl = document.getElementById('reviewText');
      const starsEl = document.getElementById('reviewStars');
      const submitBtn = document.getElementById('submitReviewBtn');
      const cancelBtn = document.getElementById('cancelReviewBtn');
      
      // Details modal
      const detailsBackdrop = document.getElementById('detailsBackdrop');
      const closeDetailsBtn = document.getElementById('closeDetailsBtn');
      const openReviewFromDetailsBtn = document.getElementById('openReviewFromDetails');
      const detailsTitleEl = document.getElementById('detailsTitle');
      const detailsMetaEl = document.getElementById('detailsMeta');
      const detailsReviewsEl = document.getElementById('detailsReviews');
      
      let selectedRating = 0;
      
      function openModal(bookName){
        bookNameEl.textContent = bookName;
        document.getElementById('reviewUsername').value = '';
        reviewTextEl.value = '';
        selectedRating = 0;
        for(const s of starsEl.querySelectorAll('.star')) s.classList.remove('selected','hover');
        backdrop.style.display = 'flex';
      }
      
      function closeModal(){ backdrop.style.display = 'none'; }
      
      document.addEventListener('click', (e)=>{
        const a = e.target.closest('.btn-review');
        if(a){ e.preventDefault(); openModal(a.getAttribute('data-book') || ''); }
        const d = e.target.closest('.btn-details');
        if(d){ e.preventDefault(); openDetails(d.getAttribute('data-book') || ''); }
        if(e.target === backdrop){ closeModal(); }
        if(e.target === detailsBackdrop){ closeDetails(); }
      });
      
      cancelBtn.addEventListener('click', closeModal);
      closeDetailsBtn.addEventListener('click', closeDetails);
      
      openReviewFromDetailsBtn.addEventListener('click', ()=>{
        const bookName = detailsTitleEl.textContent || '';
        closeDetails();
        openModal(bookName);
      });
      
      starsEl.addEventListener('mousemove', (e)=>{
        const star = e.target.closest('.star');
        if(!star) return;
        const val = Number(star.getAttribute('data-value'));
        for(const s of starsEl.querySelectorAll('.star')){
          const v = Number(s.getAttribute('data-value'));
          s.classList.toggle('hover', v <= val);
        }
      });
      
      starsEl.addEventListener('mouseleave', ()=>{
        for(const s of starsEl.querySelectorAll('.star')) s.classList.remove('hover');
        for(const s of starsEl.querySelectorAll('.star')){
          const v = Number(s.getAttribute('data-value'));
          s.classList.toggle('selected', v <= selectedRating);
        }
      });
      
      starsEl.addEventListener('click', (e)=>{
        const star = e.target.closest('.star');
        if(!star) return;
        selectedRating = Number(star.getAttribute('data-value'));
        for(const s of starsEl.querySelectorAll('.star')){
          const v = Number(s.getAttribute('data-value'));
          s.classList.toggle('selected', v <= selectedRating);
        }
      });
      
      submitBtn.addEventListener('click', async ()=>{
        const bookName = bookNameEl.textContent.trim();
        const userName = document.getElementById('reviewUsername').value.trim();
        const review = reviewTextEl.value.trim();
        const raiting = selectedRating || 0;
        
        if(!bookName){ alert('Missing book name'); return; }
        if(!userName){ alert('Please enter your name'); return; }
        if(!review){ alert('Please enter your review'); return; }
        
        try{
          const res = await fetch('/users/userreviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: userName, bookReviews: [{ name: bookName, review, raiting }] })
          });
          
          if(res.ok){
            alert('Thanks! Your review has been submitted.');
            closeModal();
            // Reload list to show the new review
            load();
            // If details are open for this book, refresh them too
            if (detailsBackdrop.style.display === 'flex') {
              openDetails(bookName);
            }
          } else {
            const text = await res.text();
            alert('Failed to submit review: ' + res.status + ' ' + text);
          }
        }catch(err){
          alert('Network error while submitting the review');
        }
      });
      
      async function openDetails(bookName){
        try {
          const res = await fetch('/books/getBooksAndReviews');
          const list = await res.json();
          const item = Array.isArray(list) ? list.find(i => (i.book && i.book.name) === bookName) : null;
          const b = item && item.book ? item.book : { name: bookName };
          
                     detailsTitleEl.textContent = b.name || bookName;
           detailsMetaEl.textContent = `Author: ${b.authore || 'Unknown'} | Genre: ${b.genre || 'Unknown'}`;
          
          const userReviews = (item && item.userAndReviewDtos) || [];
          const html = userReviews.map(ur => {
            const opt = ur.bookReviews;
            const br = (opt && (opt.review !== undefined ? opt : (opt.value || opt.get))) || null;
            const rating = br && (br.raiting != null ? br.raiting : 0);
            const review = br && br.review ? br.review : '';
            if (!review) return '';
            return `<div class="muted" style="margin:6px 0 2px 0">${ur.userName || 'Anonymous'} <span class="stars">${starsFromRating(rating)}</span></div><div class="review">${review}</div>`;
          }).join('') || '<div class="review">No reviews yet</div>';
          
          detailsReviewsEl.innerHTML = html;
          detailsBackdrop.style.display = 'flex';
        } catch (e) {
          detailsTitleEl.textContent = bookName;
          detailsMetaEl.textContent = '';
          detailsReviewsEl.innerHTML = '<div class="review">Failed to load details</div>';
          detailsBackdrop.style.display = 'flex';
        }
      }
      
      function closeDetails(){ detailsBackdrop.style.display = 'none'; }
      
             // Genre filtering functionality
       const genreSelect = document.getElementById('genreSelect');
       genreSelect.addEventListener('change', (e) => {
         const selectedGenre = e.target.value;
         if (selectedGenre) {
           loadBooksByGenre(selectedGenre);
         } else {
           load(); // Load all books
         }
       });
       
       async function loadBooksByGenre(genre) {
         const container = document.getElementById('books');
         container.innerHTML = 'Loading...';
         try {
           const res = await fetch(`/books/getBooksByGenre?genre=${encodeURIComponent(genre)}`);
           if (res.ok) {
             const list = await res.json();
             if (Array.isArray(list) && list.length > 0){
               renderBooks(container, list);
             } else {
               container.innerHTML = `<div style="text-align: center; padding: 40px; color: #666;">No books found in ${genre} genre</div>`;
             }
           } else {
             container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Failed to load books from server</div>';
           }
         } catch (e) {
           console.error('Error loading books by genre:', e);
           container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Error connecting to server</div>';
         }
       }
       
       // Call this when page loads
       document.addEventListener('DOMContentLoaded', () => {
         console.log('Books page loaded');
         load(); // Load books from MongoDB
       });
    </script>
  </body>
</html>
